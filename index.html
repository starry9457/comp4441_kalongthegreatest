<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type"
          content="text/html;
          charset=windows-1252">

    <!-- shims -->
    <script src="./midi-js/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="./midi-js/inc/shim/Base64binary.js" type="text/javascript"></script>  
    <script src="./midi-js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>

    <!-- midi.js -->
    <script src="./midi-js/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="./midi-js/js/midi/gm.js" type="text/javascript"></script>
    <script src="./midi-js/js/midi/loader.js" type="text/javascript"></script>
    <script src="./midi-js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="./midi-js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="./midi-js/js/midi/plugin.webmidi.js" type="text/javascript"></script>

    <!-- utils -->
    <script src="./midi-js/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="./midi-js/js/util/dom_request_script.js" type="text/javascript"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <style>
      .black_key { height:100px;
                   background:black;
                   position:absolute;
                   top:260px;
                    color: white}
      .white_key { height:150px; 
                   background:white;
                   position:absolute; 
                   top:260px;
                    padding-top: 100px; }
      .black_key, .white_key { width:50px; }
      .button1 { width:100px; 
                 height:30px; }
      .filter_input { width:40px; }
    </style>
  
    <title>COMP4441</title>
  </head>

  <body>
<!--   
    <label for="amplitude">MIDI amplitude (0-127):</label> <input id="amplitude" min="0" max="127" value="100" type="range"> <br>
    <label for="lowest_pitch">Lowest pitch (21-85):</label> <input id="lowest_pitch" min="21" max="85" value="60" type="range"> <br>
 -->
    <br>

    <form>
      Single note:<input name="musicMode" value="single" checked="checked" type="radio"><br>
      Major chord:<input name="musicMode" value="major" type="radio"><br>
      Minor chord:<input name="musicMode" value="minor" type="radio">
    </form>

    <form>
      <!-- First we draw the white keys -->
      <button type="button" class="white_key" data-piano-key-number="0" style="left: 50px;">Q</button>
      <button type="button" class="white_key" data-piano-key-number="2" style="left: 100px;">W</button>
      <button type="button" class="white_key" data-piano-key-number="4" style="left: 150px;">E</button>
      <button type="button" class="white_key" data-piano-key-number="5" style="left: 200px;">R</button>
      <button type="button" class="white_key" data-piano-key-number="7" style="left: 250px;">T</button>
      <button type="button" class="white_key" data-piano-key-number="9" style="left: 300px;">Y</button>
      <button type="button" class="white_key" data-piano-key-number="11" style="left: 350px;">U</button>
      <button type="button" class="white_key" data-piano-key-number="12" style="left: 400px;">V</button>
      <button type="button" class="white_key" data-piano-key-number="14" style="left: 450px;">B</button>
      <button type="button" class="white_key" data-piano-key-number="16" style="left: 500px;">N</button>
      <button type="button" class="white_key" data-piano-key-number="17" style="left: 550px;">M</button>
      <button type="button" class="white_key" data-piano-key-number="19" style="left: 600px;">,</button>
      <button type="button" class="white_key" data-piano-key-number="21" style="left: 650px;">.</button>
      <button type="button" class="white_key" data-piano-key-number="23" style="left: 700px;">/</button>

      <!-- Now we draw the black keys, so they appear on top of the white keys
      (in a web page, things included later are normally shown on top of things included earlier) --> 
      <button type="button" class="black_key" data-piano-key-number="1" style="left: 75px;">2</button>
      <button type="button" class="black_key" data-piano-key-number="3" style="left: 125px;">3</button>
      <button type="button" class="black_key" data-piano-key-number="6" style="left: 225px;">5</button>
      <button type="button" class="black_key" data-piano-key-number="8" style="left: 275px;">6</button>
      <button type="button" class="black_key" data-piano-key-number="10" style="left: 325px;">7</button>
      <button type="button" class="black_key" data-piano-key-number="13" style="left: 425px;">G</button>
      <button type="button" class="black_key" data-piano-key-number="15" style="left: 475px;">H</button>
      <button type="button" class="black_key" data-piano-key-number="18" style="left: 575px;">K</button>
      <button type="button" class="black_key" data-piano-key-number="20" style="left: 625px;">L</button>
      <button type="button" class="black_key" data-piano-key-number="22" style="left: 675px;">;</button>
    </form>

    <label for="reverb"> <input id="reverb" name="reverb" value="yes" type="checkbox">Reverb</label><br>
    <label for="filter"> <input id="filter" name="filter" value="yes" type="checkbox">Filter&nbsp;&nbsp;&nbsp; </label> 
        <input name="filter_low" class="filter_input" id="filter_low" value="0">Hz to 
        <input name="filter_high" class="filter_input" id="filter_high" value="1000">Hz<br>
    <label for="vibrato"> <input name="vibrato" id="vibrato" value="yes" type="checkbox">Vibrato</label><br>
    <label for="tremolo"> <input id="tremolo" name="tremolo" value="yes" type="checkbox">Tremolo</label><br>

    <br>

    <input name="start_button" class="button1" id="waveform-frequency" value="Start" min="1" step="1" type="button">
    <input name="end_button" class="button1" id="waveform-frequency" value="Finish" min="1" step="1" type="button">

    <script>
      var this_amplitude = 100;
      var this_pitch;
      var lowest_pitch = 60; // The MIDI pitch number for the first (left) keyboard key

      function handlePianoKeyPress(evt) {

        var this_key;

        // Show a simple message in the console
        console.log("Key press event!");

        // Determine which piano key has been pressed.
        // 'evt.target' tells us exactly which item triggered this function.
        // The piano key number is taken from the 'data-piano-key-number' attribute of each button.
        // The piano key number is a value in the range 0 to 23 inclusive.
        this_key = $(evt.target).data("pianoKeyNumber");

        // lowest_pitch = $("#lowest_pitch").val();
        // lowest_pitch = parseInt(lowest_pitch);
        this_pitch = lowest_pitch + parseInt(this_key);

        // Extract the amplitude value from the slider
        // this_amplitude = $("#amplitude").val();

        // Convert the string into actual values
        // this_amplitude = parseInt(this_amplitude);

        // Use the two numbers to start a MIDI note
        //MIDI.noteOn(0, this_pitch, this_amplitude);

        // Handle chord mode
        // Single
        if ($(":radio[name=musicMode]:checked").val() == "single"){
          MIDI.noteOn(0, this_pitch, this_amplitude);
        } 
        // Major Chord: 0, 4, 7
        else if ($(":radio[name=musicMode]:checked").val() == "major"){
          MIDI.noteOn(0, this_pitch, this_amplitude);
          MIDI.noteOn(0, this_pitch+4, this_amplitude);
          MIDI.noteOn(0, this_pitch+7, this_amplitude);
        }
        // Minor Chord: 0, 3, 7
        else if ($(":radio[name=musicMode]:checked").val() == "minor"){
          MIDI.noteOn(0, this_pitch, this_amplitude);
          MIDI.noteOn(0, this_pitch+3, this_amplitude);
          MIDI.noteOn(0, this_pitch+7, this_amplitude);
        }

      };

      function handlePianoKeyRelease(evt) {
        // Show a simple message in the console
        console.log("Key release event!");

        // Send the note off message to match the pitch of the current note on event
        //MIDI.noteOff(0, this_pitch);

        // Handle chord mode
        // Single
        if ($(":radio[name=musicMode]:checked").val() == "single"){
          MIDI.noteOff(0, this_pitch);
        } 
        // Major Chord: 0, 4, 7
        else if ($(":radio[name=musicMode]:checked").val() == "major"){
          MIDI.noteOff(0, this_pitch);
          MIDI.noteOff(0, this_pitch + 4);
          MIDI.noteOff(0, this_pitch + 7);
        }
        // Minor Chord: 0, 3, 7
        else if ($(":radio[name=musicMode]:checked").val() == "minor"){
          MIDI.noteOff(0, this_pitch, this_amplitude);
          MIDI.noteOff(0, this_pitch + 3);
          MIDI.noteOff(0, this_pitch + 7);
        }

      };

      function checkKey(e) {

          e = e || window.event;

          if (e.keyCode == '81') {
              // Q
              MIDI.noteOn(0, lowest_pitch + 0, this_amplitude);

          }
          else if (e.keyCode == '50') {
              // 2
              MIDI.noteOn(0, lowest_pitch + 1, this_amplitude);

          }
          else if (e.keyCode == '87') {
              // W
              MIDI.noteOn(0, lowest_pitch + 2, this_amplitude);

          }
          else if (e.keyCode == '51') {
              // 3
              MIDI.noteOn(0, lowest_pitch + 3, this_amplitude);

          }
          else if (e.keyCode == '69') {
              // E
              MIDI.noteOn(0, lowest_pitch + 4, this_amplitude);

          }
          else if (e.keyCode == '82') {
              // R
              MIDI.noteOn(0, lowest_pitch + 5, this_amplitude);

          }
          else if (e.keyCode == '53') {
              // 5
              MIDI.noteOn(0, lowest_pitch + 6, this_amplitude);

          }
          else if (e.keyCode == '84') {
              // T
              MIDI.noteOn(0, lowest_pitch + 7, this_amplitude);

          }
          else if (e.keyCode == '54') {
              // 6
              MIDI.noteOn(0, lowest_pitch + 8, this_amplitude);

          }
          else if (e.keyCode == '89') {
              // Y
              MIDI.noteOn(0, lowest_pitch + 9, this_amplitude);

          }
          else if (e.keyCode == '55') {
              // 7
              MIDI.noteOn(0, lowest_pitch + 10, this_amplitude);

          }
          else if (e.keyCode == '85') {
              // U
              MIDI.noteOn(0, lowest_pitch + 11, this_amplitude);

          }
          else if (e.keyCode == '86') {
              // V
              MIDI.noteOn(0, lowest_pitch + 12, this_amplitude);

          }
          else if (e.keyCode == '71') {
              // G
              MIDI.noteOn(0, lowest_pitch + 13, this_amplitude);

          }
          else if (e.keyCode == '66') {
              // B
              MIDI.noteOn(0, lowest_pitch + 14, this_amplitude);

          }
          else if (e.keyCode == '72') {
              // H
              MIDI.noteOn(0, lowest_pitch + 15, this_amplitude);

          }
          else if (e.keyCode == '78') {
              // N
              MIDI.noteOn(0, lowest_pitch + 16, this_amplitude);

          }
          else if (e.keyCode == '77') {
              // M
              MIDI.noteOn(0, lowest_pitch + 17, this_amplitude);

          }
          else if (e.keyCode == '75') {
              // K
              MIDI.noteOn(0, lowest_pitch + 18, this_amplitude);

          }
          else if (e.keyCode == '188') {
              // ,
              MIDI.noteOn(0, lowest_pitch + 19, this_amplitude);

          }
          else if (e.keyCode == '76') {
              // L
              MIDI.noteOn(0, lowest_pitch + 20, this_amplitude);

          }
          else if (e.keyCode == '190') {
              // .
              MIDI.noteOn(0, lowest_pitch + 21, this_amplitude);

          }
          else if (e.keyCode == '186') {
              // ;
              MIDI.noteOn(0, lowest_pitch + 22, this_amplitude);

          }
          else if (e.keyCode == '191') {
              // /
              MIDI.noteOn(0, lowest_pitch + 23, this_amplitude);

          }

      }
      $( document ).ready( function() {
          MIDI.loadPlugin({ soundfontUrl: "./midi-js/soundfont/",
                            instrument: "acoustic_grand_piano",
                            onprogress: function(state, progress) { console.log(state, progress); },
                            onsuccess: function() {
                              // At this point the MIDI system is ready to be used
                              MIDI.setVolume(0, 127); // Set the general volume level
                              MIDI.programChange(0, 0); // Use the General MIDI 'acoustic_grand_piano' number

                              // Set up the event handlers for all the buttons
                              $("button").on("mousedown", handlePianoKeyPress);
                              $("button").on("mouseup", handlePianoKeyRelease);
                                document.onkeydown = checkKey;
                            }
          });
      });
    </script>
  </body>
</html>